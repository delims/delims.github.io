---
layout: post
author: delims
categories: 系统
---



# 第二部分
## 第 7 章 链接

链接（linking）是将各种代码和数据片段收集并组合成为一个单一文件的过程，这个文件可以被加载到内存并执行。

链接可以执行于编译时、加载时甚至运行时。

#### 7.1 编译器驱动程序

shell 调用操作系统中一个叫做加载器的函数，它将可执行文件中的代码和数据复制到内存，然后将控制权移动到这个程序的开头。

#### 7.2 静态链接

静态连接器（static linker） 以一组可重定位目标文件和命令行参数作为输入，生成一个完全连接的、可以加载和运行的可执行目标文件作为输出。连接器的主要任务：

- **符号解析** 解析目标文件中定义和引用符号，每个符号对应于一个函数、一个全局变量或一个静态变量。

- **重定位** 把每个符号定义与一个内存地址关联起来，修改所有对这些符号的引用，使他们指定这个内存地址。

#### 7.3 目标文件

目标文件有三种形式：

- **可重定位目标文件**。包含二进制代码和数据。
- **可执行目标文件**，就是可执行程序。
- **共享目标文件**，就是动态库，可以在运行时动态地加载到内存并链接。

Linux 和 Unix 系统使用**可执行可连接格式**（Executable and Linkable Format，**ELF**）作为可执行文件格式。

#### 7.4 可重定位目标文件

文件头部信息以一个16字节的序列开始。包含的节有：

- **.text** ：已编译程序的机器代码。
- **.rodata** : 只读数据，比如常量字符串。
- **.data** : 已初始化的全局和静态C变量。不包括临时变量。
- **.bss** :  未初始化以及被初始化为0的全局和静态C变量，仅仅是一个占位符不占磁盘空间，运行时，在内存中分配这些变量初始化为0。
- **.symtab** : 符号表，存放全局信息，函数和变量。
- **.debug** : 一个调试符号表。包含局部变量和类型定义，原始C源文件。只有gcc -g 选项才可以生成这张表。
- **.line** : 原始 C 源程序中的行号和 .text 节中机器指令之间的映射。只有gcc -g 选项才可以生成这张表。
- **.strtab** : 一个字符串表，包含 .symtab 和 .debug 节中的符号表，以及节头部中的节名字。字符串表就是以null结尾的字符串的序列。

#### 7.5 符号和符号表

每个可重定位模块都有一个符号表，包含它定义和引用的符号信息。在连接器的上下文中有三种不同的符号：

- 当前模块中定义并能被其他模块引用的全局符号。对应于非静态函数和全局变量。
- 由其他模块定义并被本模块引用的全局符号。称为**外部符号**。对应于其他模块中的非静态函数和全局变量。
- 只被当前模块定义和引用的局部符号。使用 static 修饰的函数和全局变量，对其它不可见。

连接器符号不包括临时变量，临时变在运行时栈中被管理。

在C语言中，源文件扮演模块的角色，任何只在本模块内使用的函数或者全局变量应该声明为 static ，这样起到保护作用，就像 C++ 中的 private 一样。

#### 7.6.1 连接器如何解析多重定义的全局符号

连接器的输入是一组可重定位目标模块。每个模块定义一组符号，有些是局部的只对当前模块可见，有些是全局的对所有模块可见。如果有多个模块定义同名全局符号，会发生什么？

符号分为强符号和弱符号。函数和已初始化的全局变量是强符号，未初始化的全局变量是弱符号。链接处理多重符号的规则：

1. 不允许有多个同名强符号。
2. 如果一个强符号和多个弱同名，选择强符号。
3. 如果有多个同名弱符号，则任选一个弱符号。

#### 7.6.2 与静态库链接

- 和与目标文件链接不同，在连接时，连接器只复制被程序引用的模块。
- 在 Linux 系统中，静态库以一种称为存档的特殊文件格式存放在磁盘中。存档文件是一组连接起来的可重定位目标文件的集合。有一个头部用来描述每个成员目标文件的大小和位置。

#### 7.7 重定位

完成符号解析后，连接器知道它的输入目标模块中代码节和数据节的大小。就可以进行重定位步骤，合并输入模块为每个符号分配运行时地址。

- **重定位节和符号定义**。将所有模块中同名的节合并。
- **重定位节中的符号引用**。修改代码节和数据节中对每个符号的引用，使他们指向正确的运行时地址。

#### 7.7 重定位条目

目标文件并不知道数据和代码最终放在内存什么位置。也不知道引用外部符号的位置。代码生成一个重定位条目放在 .rel.text 中。数据生成重定位条目放在 .rel.data 中。











