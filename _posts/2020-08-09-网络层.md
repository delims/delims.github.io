---
layout: post
author: delims
categories: 网络
---

> 将网络互连起来要使用一些中间设备，根据中间设备所在的层次划分：

1. 物理层时候用的中间是被叫**转发器**(repeater)，**集线器**是多网口的**转发器**。
2. 数据链路层使用的中间设备叫**网桥**或**桥接器**(bridge)，**交换机**是多网口的**网桥**。
3. 网络层使用的中间设备叫**路由器**(router)。
4. 在网络层以上使用的中间设备叫**网关**(geteway)。

- 当中间设备是转发器或网桥时，这仅仅是把一个网络扩大了，而从网络层的角度看，这仍然是一个网络。

> 现在主要使用**无分类编址**(CIDR)，IP地址分类早已成为历史，稍微了解一下

| 分类 | 前缀 | 网络号位数 | 主机号位数 |
| --- | --- | --- | --- |
| A类 | 0 | 8 | 24 |
| B类 | 10 | 16 | 16 |
| C类 | 110 | 24 | 8 |
| D类型 | 1110 |   |

其中D类地址主要用于**多播**。

我们知道一个网络号中有很多主机号。我们要给一个主机发数据，路由器只是查找网络号，找到目标网络号，然后交付目标主机。

这里我个人理解为 D 类地址的网络号是 32 位。主机号0位。所以每个D类地址都代表一组主机，所有用于多播。

# 地址解析协议 ARP 

- 每一台主机都有一个ARP高速缓存，里面记录了本局域网内IP地址和MAC地址的对应关系。ARP高速缓存有一个过期时间。比如 10~20 分钟。
- 给局域网内的主机发消息的时候就查找ARP缓存。找到了直接拿出MAC地址使用。如果找不到，就发送一个ARP请求分组。
- ARP请求分组的的目标 MAC地址 为 **ff:ff:ff:ff:ff:ff** ，在局域网内的每一台主机都能数到这个分组，他们看看自己的IP地址是不是和请求分组询问的IP地址一致。如果不一致就不理睬。如果一致就通过单播告诉源主机自己的mac地址。同时把对方的MAC地址也写入自己ARP缓存。源主机收到回应后也把对方MAC写入缓存。

> ARP 分组格式，长度单位：字节

|  字段 | 硬件类型 | 协议类型 | 硬件地址长度 | 协议地址长度 | op | 发送端MAC | 发送端IP | 目的MAC | 目的IP |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| 长度 | 2 | 2 | 1 | 1 | 2 | 6 | 4 | 6 | 4 |

ARP 请求/应答分组固定 **28** 字节。前面加上 **14** 字节的MAC帧首部即构成总长度 **42** 字节的ARP分组。

|  字段 |  长度 | 说明 |
| --- | --- | --- | 
| 硬件地址类型 | 2 | 硬件地址不止以太网一种，如果是以太网设置为 1 |
| 协议类型 | 2 | 映射的协议地址类型，要对IPv4进行映射，值为 0x0800 |
| 硬件地址长度 | 1 | MAC地址长度为 6 字节，值为 6 |
| 协议地址长度 | 1 | IP地址长度为 4 字节，值为 4 |
| op | 2 | 操作类型。1 是 ARP请求；2 是ARP应答；3 是RARP请求；4 是RARP应答 | 
| 发送端MAC地址 | 6 | 和MAC帧源MAC地址一致 |
| 发送端IP地址 | 4 | 发送端的IP地址 |
| 目的MAC地址 | 6 | 目的MAC地址 |
| 目的IP地址 | 4 | 目的IP地址 |

# IP数据报的格式

> IP数据报有 **20** 字节的固定首部。我按照自己的理解分成每 **4** 个字节一块，并给每一块取了一个名字，只是为了方便记忆。

|  分区 |  长度 | 字段 | 字段 | 字段 | 字段 |
| --- | --- | --- | --- | --- | --- | --- | 
| 总体概况 |  4 | 版本 4b | 首部长度 4b | 区分服务 1B | 总长度 2B |
| 分片相关 |  4  | 标识 2B | 标志 3b | 片偏移 13b |
| 交付相关 |  4  | 生存时间 1B | 协议 1B | 首部校验和 2B | 
| 原地址 |  4  | 源IP地址 4B |
| 目的地址 |  4  | 目的IP地址 4B |
| 选项 |  4n | 长度可变，为4字节的整数倍，不足填0 |

> 字段说明 

| 字段 |  长度 | 说明 |
| --- | --- | --- | 
| 版本 | 4b | IP协议版本，如果是IPv4值为4 |
| 首部长度 | 4b | IP首部的长度，单位4B，最大值15说明IP数据报头部长度最大60字节 |
| 区分服务 | 1B | 用来获得更好的服务，很少使用 |
| 总长度 | 2B | 首部和数据总长度，单位是字节，最大值 65535 即 64KB ，一般都用不到这么大，一般 MTU 才1500 |
| 标识 | 2B | 标识一个IP数据报，用于分片后的组装 |
| 标志 | 3b | 第1位保留；第2位 DF，只有DF=0才允许分片；第3位MF，MF=1表示后面还有分片 |
| 生存时间 | 4b | TTL (Time To Live) ，每经过一个路由器就减 1，到0就丢弃。数值表示能经过多少个路由器 |
| 协议 | 1B | 携带数据使用的协议，目标主机通过该字段得知把数据交给谁 |
| 首部校验和 | 2B | 只校验首部，通过二进制反码求和计算校验和 |
| 源IP地址 | 4B | 注意源IP地址在前面 |
| 目的IP地址 | 4B | 注意目的IP地址在后面 |

